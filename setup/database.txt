-- Zion Fee Payment Portal - Complete Database Schema
-- Creates all necessary tables for the school fee management system

-- Create database
CREATE DATABASE IF NOT EXISTS `zion`
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE `zion`;

-- 1. Users table - Core authentication and user data
CREATE TABLE IF NOT EXISTS `users` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `username` VARCHAR(50) NOT NULL UNIQUE,
  `email` VARCHAR(100) NOT NULL UNIQUE,
  `password` VARCHAR(255) NOT NULL,
  `first_name` VARCHAR(50) NOT NULL,
  `last_name` VARCHAR(50) NOT NULL,
  `contact` VARCHAR(15) NOT NULL,
  `user_type` ENUM('admin','student') NOT NULL DEFAULT 'student',
  `total_paid` DECIMAL(10,2) NOT NULL DEFAULT 0,
  `last_payment_date` TIMESTAMP NULL DEFAULT NULL,
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_users_username` (`username`),
  KEY `idx_users_email` (`email`),
  KEY `idx_users_type` (`user_type`)
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- 2. Classes table - School class management (Class 1-10)
CREATE TABLE IF NOT EXISTS `classes` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(50) NOT NULL UNIQUE,
  `code` VARCHAR(10) DEFAULT NULL,
  `is_active` TINYINT(1) NOT NULL DEFAULT 1,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_classes_active` (`is_active`)
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- 3. Student details table - Extended student information
CREATE TABLE IF NOT EXISTS `student_details` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` INT UNSIGNED NOT NULL,
  `student_id` VARCHAR(20) NOT NULL UNIQUE,
  `course` VARCHAR(100) DEFAULT NULL,
  `semester` VARCHAR(20) DEFAULT NULL,
  `class_level` VARCHAR(20) DEFAULT NULL,
  `fee_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00,
  `outstanding_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00,
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_student_id` (`student_id`),
  KEY `idx_student_details_user_id` (`user_id`),
  KEY `idx_student_class_level` (`class_level`),
  CONSTRAINT `fk_student_details_user`
    FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- 4. Fee structures table - Configurable fees by class level
CREATE TABLE IF NOT EXISTS `fee_structures` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `title` VARCHAR(150) DEFAULT NULL,
  `course_name` VARCHAR(100) DEFAULT NULL,
  `semester` VARCHAR(50) DEFAULT NULL,
  `class_level` VARCHAR(20) DEFAULT NULL,
  `amount` DECIMAL(10,2) NOT NULL,
  `due_date` DATE DEFAULT NULL,
  `late_fee` DECIMAL(10,2) DEFAULT NULL,
  `is_active` TINYINT(1) NOT NULL DEFAULT 1,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_fee_class_level` (`class_level`),
  KEY `idx_fee_active` (`is_active`),
  KEY `idx_fee_due_date` (`due_date`)
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- 5. Payments table - Transaction records with fee linking
CREATE TABLE IF NOT EXISTS `payments` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` INT UNSIGNED NOT NULL,
  `fee_id` INT UNSIGNED DEFAULT NULL,
  `amount` DECIMAL(10,2) NOT NULL,
  `payment_method` VARCHAR(50) NOT NULL,
  `transaction_id` VARCHAR(100) NOT NULL UNIQUE,
  `status` VARCHAR(20) NOT NULL DEFAULT 'completed',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_transaction_id` (`transaction_id`),
  KEY `idx_payments_user_id` (`user_id`),
  KEY `idx_payments_fee_id` (`fee_id`),
  KEY `idx_payments_status` (`status`),
  KEY `idx_payments_created_at` (`created_at`),
  CONSTRAINT `fk_payments_user`
    FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)
    ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_payments_fee`
    FOREIGN KEY (`fee_id`) REFERENCES `fee_structures`(`id`)
    ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- Insert default admin user (password: admin123)
INSERT INTO `users` (`username`, `email`, `password`, `first_name`, `last_name`, `contact`, `user_type`)
VALUES (
  'admin',
  'admin@zion.edu',
  '$2y$10$T1Zb4C0ghk5h2m5bIhQK1e0r2xN9Jk1mS4F5nE0Qqv0Qe5qGmU6h2', -- hash of 'admin123'
  'System',
  'Administrator',
  '0000000000',
  'admin'
)
ON DUPLICATE KEY UPDATE
  `username` = VALUES(`username`);

-- Insert standard classes (Class 1-10)
INSERT INTO `classes` (`name`, `code`) VALUES
('Class 1', 'I'),
('Class 2', 'II'),
('Class 3', 'III'),
('Class 4', 'IV'),
('Class 5', 'V'),
('Class 6', 'VI'),
('Class 7', 'VII'),
('Class 8', 'VIII'),
('Class 9', 'IX'),
('Class 10', 'X')
ON DUPLICATE KEY UPDATE
  `name` = VALUES(`name`);

-- Insert sample fee structures for each class
INSERT INTO `fee_structures` (`title`, `class_level`, `amount`, `due_date`) VALUES
('Class 1 Annual Fees', 'Class 1', 8000.00, '2024-04-30'),
('Class 2 Annual Fees', 'Class 2', 8500.00, '2024-04-30'),
('Class 3 Annual Fees', 'Class 3', 9000.00, '2024-04-30'),
('Class 4 Annual Fees', 'Class 4', 9500.00, '2024-04-30'),
('Class 5 Annual Fees', 'Class 5', 10000.00, '2024-04-30'),
('Class 6 Annual Fees', 'Class 6', 11000.00, '2024-04-30'),
('Class 7 Annual Fees', 'Class 7', 12000.00, '2024-04-30'),
('Class 8 Annual Fees', 'Class 8', 13000.00, '2024-04-30'),
('Class 9 Annual Fees', 'Class 9', 14000.00, '2024-04-30'),
('Class 10 Annual Fees', 'Class 10', 15000.00, '2024-04-30')
ON DUPLICATE KEY UPDATE
  `amount` = VALUES(`amount`);

-- Setup complete! Login with: admin/admin123